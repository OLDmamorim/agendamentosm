<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"/>
  <title>Portal de Agendamento</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Salvaguarda m√≠nima caso o style.css n√£o tenha estas classes */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fafafa;color:#222;margin:0}
    .page{max-width:1200px;margin:0 auto;padding:12px}
    .page-header{padding:16px 8px 8px;text-align:center}
    .page-header h1{margin:0 0 4px}
    .subtitle{margin:0;color:#666}
    .nav-bar{display:flex;gap:12px;align-items:center;justify-content:space-between;background:#fff;border:1px solid #eee;border-radius:10px;padding:8px 12px;margin:12px 0}
    .nav-left,.nav-right{display:flex;gap:8px;align-items:center}
    .nav-button{border:1px solid #ddd;background:#f7f7f7;padding:8px 12px;border-radius:8px;cursor:pointer}
    .nav-button:hover{background:#efefef}
    .week-range{font-weight:600}
    .schedule-container,.unscheduled-container,.services-table-container,.form-container{background:#fff;border:1px solid #eee;border-radius:10px;padding:12px;margin:12px 0}
    table.schedule{width:100%;border-collapse:collapse}
    table.schedule th,table.schedule td{border:1px solid #eee;vertical-align:top}
    table.schedule th{background:#fafafa;padding:8px}
    table.schedule td{height:180px;position:relative}
    .drop-zone{min-height:8px}
    .appointment{background:#eef6ff;border-left:6px solid #3a7afe;padding:8px;border-radius:8px;margin:6px 0;font-size:13px}
    .appt-header{font-weight:600}
    .appt-sub{opacity:.85}
    .pill{border:1px solid #cfe0ff;background:#fff;border-radius:999px;padding:2px 6px;font-size:11px;margin-left:6px}
    .empty{color:#666;background:#f8f8f8;border:1px dashed #ddd;border-radius:8px;padding:12px;text-align:center}
    .appointment-form{display:grid;grid-template-columns:repeat(6,minmax(140px,1fr));gap:10px}
    .form-row{grid-column:1/-1;display:grid;grid-template-columns:inherit;gap:10px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-actions{grid-column:1/-1;display:flex;gap:8px;justify-content:flex-end}
    .secondary-button,.submit-button{border:1px solid #ddd;background:#f7f7f7;padding:8px 12px;border-radius:8px;cursor:pointer}
    .submit-button{background:#e9f5ff;border-color:#b9ddff}
    .services-table{width:100%;border-collapse:collapse}
    .services-table th,.services-table td{border:1px solid #eee;padding:6px 8px;font-size:14px}
    .chip{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid #ddd;background:#fff;font-size:12px}
    .badge{padding:2px 6px;border-radius:6px;border:1px solid #ddd;background:#fff}
    .locality-picker-ctrl{position:relative}
    .locality-button{display:flex;align-items:center;gap:8px;border:1px solid #ddd;background:#f7f7f7;padding:8px;border-radius:8px;cursor:pointer}
    .locality-menu{position:absolute;right:0;top:calc(100% + 6px);background:#fff;border:1px solid #eee;border-radius:8px;box-shadow:0 6px 24px rgba(0,0,0,.08);min-width:220px;display:none;z-index:5}
    .locality-menu.open{display:block}
    .loc-item{padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer}
    .loc-item:hover{background:#f7f7f7}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block;background:#d1d5db}
    @media print{
      .nav-bar,.form-container,.mobile-day-container{display:none}
      .print-page-1{page-break-after:always}
      .print-page-3{page-break-before:always}
      .print-show{display:block}
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1>PORTAL DE AGENDAMENTO</h1>
      <p class="subtitle">Agendamento servi√ßos Expressglass</p>
    </header>

    <div class="nav-bar">
      <div class="nav-left">
        <button id="prevWeek" class="nav-button">&lt; Anterior</button>
        <button id="nextWeek" class="nav-button">Pr√≥xima &gt;</button>
        <button id="todayWeek" class="nav-button">üìÖ Hoje</button>
      </div>
      <div class="week-range" id="weekRange">‚Äî</div>
      <div class="nav-right">
        <button id="printPage" class="nav-button">üñ® Imprimir</button>
      </div>
    </div>

    <!-- Calend√°rio (desktop) -->
    <div class="schedule-container print-page-1">
      <table id="schedule" class="schedule"></table>
    </div>

    <!-- Servi√ßos por agendar -->
    <section class="unscheduled-container">
      <h3>SERVI√áOS POR AGENDAR</h3>
      <div id="unscheduledList" class="unscheduled-list" data-drop-bucket="unscheduled"></div>
    </section>

    <!-- Vista di√°ria (mobile - s√≥ leitura) -->
    <section id="mobileDayView" class="mobile-day-container">
      <div class="mobile-day-header">
        <div id="mobileDayLabel" class="mobile-day-label">‚Äî</div>
        <div class="mobile-day-buttons">
          <button id="prevDay" class="nav-button small full">‚óÄ Dia anterior</button>
          <button id="todayDay" class="nav-button small full">Hoje</button>
          <button id="nextDay" class="nav-button small full">Dia seguinte ‚ñ∂</button>
        </div>
      </div>
      <div id="mobileDayList" class="mobile-day-list"></div>
    </section>

    <!-- Tabela de servi√ßos (desktop/print) -->
    <div class="services-table-container print-page-2">
      <h3>SERVI√áOS A REALIZAR</h3>
      <p class="services-subtitle">Todos os servi√ßos desde hoje em diante</p>
      <table id="servicesTable" class="services-table">
        <thead>
          <tr>
            <th>Data</th><th>Per√≠odo</th><th>Matr√≠cula</th><th>Carro</th>
            <th>Servi√ßo</th><th>Localidade</th><th>Observa√ß√µes</th><th>Estado</th><th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Formul√°rio -->
    <div class="form-container">
      <h3>Novo Agendamento</h3>
      <form id="appointmentForm" class="appointment-form" autocomplete="off">
        <input type="hidden" id="editId" />
        <div class="form-row">
          <div class="form-group">
            <label for="date">Data</label>
            <input type="date" id="date" />
          </div>
          <div class="form-group">
            <label for="period">Per√≠odo</label>
            <select id="period">
              <option value="">‚Äî</option>
              <option value="Manh√£">Manh√£</option>
              <option value="Tarde">Tarde</option>
            </select>
          </div>
          <div class="form-group">
            <label for="plate">Matr√≠cula *</label>
            <input type="text" id="plate" placeholder="XX-XX-XX" required />
          </div>
          <div class="form-group">
            <label for="car">Modelo do Carro *</label>
            <input type="text" id="car" placeholder="Ex: BMW X3" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="service">Tipo de Servi√ßo *</label>
            <select id="service" required>
              <option value="">Selecione o tipo de servi√ßo</option>
              <option value="PB">PB (Para-brisa)</option>
              <option value="LT">LT (Lateral)</option>
              <option value="OC">OC (Outros Cristais)</option>
              <option value="REP">REP (Repara√ß√£o)</option>
              <option value="POL">POL (Polimento)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Localidade *</label>
            <div class="locality-picker-ctrl" id="localityCtrl">
              <div class="locality-button" id="localityBtn">
                <span class="dot" id="localityDot"></span>
                <span id="localityText">Selecione a localidade</span>
                <span class="chev">‚ñ¥</span>
              </div>
              <div class="locality-menu" id="localityMenu"></div>
              <input type="hidden" id="locality" required />
            </div>
          </div>

          <div class="form-group">
            <label for="status">Status do Vidro *</label>
            <select id="status" required>
              <option value="NE">N/E</option>
              <option value="VE">V/E</option>
            </select>
          </div>
          <div class="form-group">
            <label for="notes">Observa√ß√µes</label>
            <input type="text" id="notes" placeholder="Ex: Centro da Vila"/>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group" style="grid-column: 1 / -1;">
            <label for="extra">Outros dados (opcional)</label>
            <textarea id="extra" rows="2" placeholder="Informa√ß√µes adicionais (n√£o aparece no calend√°rio)"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" id="clearForm" class="secondary-button">Limpar</button>
          <button type="submit" id="submitBtn" class="submit-button">Criar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- === Helpers de API (Netlify Functions) === -->
  <script>
    const API = '/.netlify/functions/appointments';

    async function http(method, bodyOrParams) {
      let url = API;
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (method === 'GET') {
        const params = new URLSearchParams(bodyOrParams || {});
        url += `?${params.toString()}`;
      } else {
        opts.body = JSON.stringify(bodyOrParams || {});
      }
      const res = await fetch(url, opts);
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data?.error || `API error (${res.status})`);
      return data;
    }

    async function apiListar(weekStart, weekEnd){ return http('GET', { weekStart, weekEnd }); }
    async function apiCriar(obj){ return http('POST', obj); }
    async function apiAtualizar(id, patch){ return http('PUT', { id, ...patch }); }
    async function apiApagar(id){ return http('DELETE', { id }); }
  </script>

  <!-- === L√≥gica da p√°gina (adaptada para API) === -->
  <script>
    // ---------- Config ----------
    const localityColors = {
      "Outra":"#9CA3AF",
      "Barcelos":"#F87171","Braga":"#34D399","Esposende":"#22D3EE","Famalic√£o":"#2DD4BF",
      "Guimar√£es":"#FACC15","P√≥voa de Lanhoso":"#A78BFA","P√≥voa de Varzim":"#6EE7B7",
      "Riba D'Ave":"#FBBF24","Trofa":"#C084FC","Vieira do Minho":"#93C5FD",
      "Vila do Conde":"#FCD34D","Vila Verde":"#86EFAC"
    };
    const statusBarColors = { NE:"#EF4444", VE:"#10B981" };
    const localityList = Object.keys(localityColors);

    // ---------- Estado (s√≥ mem√≥ria para render) ----------
    let appointments = []; // ser√° preenchido a partir da API
    const startOfWeek = date => { const d=new Date(date); const day=d.getDay(); const delta=(day===0?-6:1-day); d.setDate(d.getDate()+delta); d.setHours(0,0,0,0); return d; };
    const addDays = (d,n)=>{ const r=new Date(d); r.setDate(r.getDate()+n); return r; };
    const localISO = dLike => { const d=new Date(dLike); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; };
    const fmtHeader = d => ({ day:d.toLocaleDateString('pt-PT',{weekday:'long'}), dm:d.toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit'}) });
    const formatPT = iso => { if(!iso) return ''; const [y,m,da]=iso.split('-'); return `${da}/${m}/${y}`; };
    const cap = s=>s.charAt(0).toUpperCase()+s.slice(1);
    const hex2rgba = (hex,a=1)=>{const m=hex.replace('#','');const b=parseInt(m,16);return `rgba(${(b>>16)&255},${(b>>8)&255},${b&255},${a})`; };
    let currentMonday = startOfWeek(new Date());
    let mobileDay = localISO(new Date());

    // ---------- Locality dropdown ----------
    function buildLocalityMenu(){
      const menu = document.getElementById('localityMenu'); if(!menu) return;
      menu.innerHTML='';
      const list = localityList.includes("Outra") ? localityList : [...localityList, "Outra"];
      list.forEach(loc=>{
        const item = document.createElement('div');
        item.className = 'loc-item';
        const dot = document.createElement('span'); dot.className='dot'; dot.style.backgroundColor = localityColors[loc] || '#d1d5db';
        const label = document.createElement('span'); label.textContent = loc;
        item.appendChild(dot); item.appendChild(label);
        item.addEventListener('click', ()=> selectLocality(loc));
        menu.appendChild(item);
      });
    }
    function openLocalityMenu(){
      const menu=document.getElementById('localityMenu');
      menu.classList.toggle('open');
      document.addEventListener('click', closeIfOutside, {once:true});
    }
    function closeIfOutside(e){ if(!e.target.closest('#localityCtrl')) document.getElementById('localityMenu').classList.remove('open'); else document.addEventListener('click', closeIfOutside, {once:true}); }
    function selectLocality(loc){
      document.getElementById('locality').value = loc;
      document.getElementById('localityText').textContent = loc;
      document.getElementById('localityDot').style.backgroundColor = localityColors[loc] || '#d1d5db';
      document.getElementById('localityMenu').classList.remove('open');
    }

    // ---------- Render Calend√°rio ----------
    function renderSchedule(){
      const table = document.getElementById('schedule'); table.innerHTML='';
      const week = [...Array(5)].map((_,i)=>addDays(currentMonday,i));
      document.getElementById('weekRange').textContent =
        `${week[0].toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit'})} - ${week[4].toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit',year:'numeric'})}`;

      let thead = '<thead><tr><th>Per√≠odo</th>';
      for(const d of week){ const h=fmtHeader(d); thead += `<th><div class="day">${cap(h.day)}</div><div class="date">${h.dm}</div></th>`; }
      thead += '</tr></thead>';
      table.insertAdjacentHTML('beforeend', thead);

      const renderCell = (period, dayDate) => {
        const iso = localISO(dayDate);
        const items = appointments.filter(a=>a.date===iso && a.period===period);
        const drop = `<div class="drop-zone" data-drop-bucket="${iso}|${period}"></div>`;
        return drop + items.map(a=>{
          const bg = localityColors[a.locality]||'#EEE'; const bar = statusBarColors[a.status]||'#999';
          return `<div class="appointment" data-id="${a.id}" style="background-color:${hex2rgba(bg,0.65)}; border-left:6px solid ${bar}">
            <div class="appt-header">${a.plate} | ${a.service} | ${a.car.toUpperCase()} <span class="pill">${a.period}</span></div>
            <div class="appt-sub">${a.locality || ''} ${a.notes?(' | '+a.notes):''}</div>
            <div class="appt-status">
              <label><input type="checkbox" data-status="NE" ${a.status==='NE'?'checked':''}/> N/E</label>
              <label><input type="checkbox" data-status="VE" ${a.status==='VE'?'checked':''}/> V/E</label>
            </div>
          </div>`;
        }).join('');
      };

      let body = '<tbody>';
      for(const period of ['Manh√£','Tarde']){ body += `<tr><th>${period}</th>`; for(const d of week){ body += `<td class="cell" data-drop-bucket="${localISO(d)}|${period}">${renderCell(period,d)}</td>`; } body += '</tr>'; }
      body += '</tbody>';
      table.insertAdjacentHTML('beforeend', body);

      table.querySelectorAll('.appointment input[type=checkbox]').forEach(cb=>cb.addEventListener('change', onCardStatusChange));
    }

    // ---------- N√£o agendados ----------
    function renderUnscheduled(){
      const wrap = document.getElementById('unscheduledList'); if(!wrap) return;
      wrap.innerHTML='';
      const rows = appointments.filter(a=>!a.date);
      if(rows.length===0){ wrap.innerHTML = '<div class="empty">Nenhum servi√ßo por agendar.</div>'; return; }
      rows.forEach(a=>{
        const bg = localityColors[a.locality] || '#EEE';
        const bar = statusBarColors[a.status] || '#999';
        const card = document.createElement('div');
        card.className='appointment unscheduled';
        card.dataset.id=a.id;
        card.style.backgroundColor = hex2rgba(bg,0.65);
        card.style.borderLeft = `6px solid ${bar}`;
        card.innerHTML = `
          <div class="appt-header">${a.plate} | ${a.service} | ${a.car.toUpperCase()}</div>
          <div class="appt-sub">${a.locality || ''} ${a.notes?(' | '+a.notes):''}</div>
          <div class="appt-status">
            <label><input type="checkbox" data-status="NE" ${a.status==='NE'?'checked':''}/> N/E</label>
            <label><input type="checkbox" data-status="VE" ${a.status==='VE'?'checked':''}/> V/E</label>
          </div>
          <div class="unscheduled-actions">
            <button class="icon delete" title="Eliminar" data-id="${a.id}">üóëÔ∏è</button>
          </div>`;
        wrap.appendChild(card);
      });
      wrap.querySelectorAll('.appointment input[type=checkbox]').forEach(cb=>cb.addEventListener('change', onCardStatusChange));
      wrap.querySelectorAll('button.delete').forEach(b=>b.addEventListener('click', onDelete));
    }

    // ---------- Tabela Servi√ßos ----------
    function renderServicesTable(){
      const tb = document.querySelector('#servicesTable tbody'); tb.innerHTML='';
      const rows = appointments.filter(a=>a.date)
        .sort((a,b)=> a.date===b.date ? (a.period||'').localeCompare(b.period||'') : a.date.localeCompare(b.date));
      for(const a of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${formatPT(a.date)}</td><td>${a.period||''}</td><td>${a.plate}</td><td>${a.car}</td>
                        <td><span class="badge">${a.service}</span></td>
                        <td>${a.locality||''}</td><td>${a.notes||''}</td>
                        <td><span class="chip">${a.status==='NE'?'N/E':'V/E'}</span></td>
                        <td class="actions">
                          <button class="icon delete" data-id="${a.id}">üóëÔ∏è</button>
                        </td>`;
        tb.appendChild(tr);
      }
      tb.querySelectorAll('button.delete').forEach(b=>b.addEventListener('click', onDelete));
    }

    // ---------- Mobile ----------
    const mobileDayLabel = document.getElementById('mobileDayLabel');
    function renderMobileDay(){
      const list = document.getElementById('mobileDayList'); if(!list) return;
      list.innerHTML='';
      const rows = appointments.filter(a=>a.date===mobileDay).sort((a,b)=> (a.period+a.plate).localeCompare(b.period+b.plate));
      mobileDayLabel.textContent = new Date(mobileDay).toLocaleDateString('pt-PT',{weekday:'long', day:'2-digit', month:'long', year:'numeric'});
      if(rows.length===0){ list.innerHTML='<div class="empty">Sem servi√ßos para este dia.</div>'; return; }
      for(const a of rows){
        const bg = localityColors[a.locality]||'#EEE'; const bar = statusBarColors[a.status]||'#999';
        const card = document.createElement('div'); card.className='appointment mobile'; card.style.backgroundColor=hex2rgba(bg,0.65); card.style.borderLeft=`6px solid ${bar}`;
        card.innerHTML = `<div class="appt-header">${a.plate} | ${a.service} | ${a.car.toUpperCase()} <span class="pill">${a.period||''}</span></div>
                          <div class="appt-sub">${a.locality || ''} ${a.notes||''}</div>`;
        list.appendChild(card);
      }
    }
    document.getElementById('prevDay').addEventListener('click', ()=>{ mobileDay = localISO(addDays(new Date(mobileDay),-1)); renderMobileDay(); });
    document.getElementById('nextDay').addEventListener('click', ()=>{ mobileDay = localISO(addDays(new Date(mobileDay), 1)); renderMobileDay(); });
    document.getElementById('todayDay').addEventListener('click', ()=>{ mobileDay = localISO(new Date()); renderMobileDay(); });

    // ---------- Eventos globais ----------
    document.getElementById('prevWeek').addEventListener('click', async ()=>{ currentMonday = addDays(currentMonday,-7); await loadWeek(); });
    document.getElementById('nextWeek').addEventListener('click', async ()=>{ currentMonday = addDays(currentMonday, 7); await loadWeek(); });
    document.getElementById('todayWeek').addEventListener('click', async ()=>{ currentMonday = startOfWeek(new Date()); await loadWeek(); });

    document.getElementById('printPage').addEventListener('click', ()=>{ window.print(); });
    document.getElementById('localityBtn').addEventListener('click', ()=>{
      document.getElementById('localityMenu').classList.toggle('open');
    });

    // ---------- Form ----------
    const form = document.getElementById('appointmentForm'); const submitBtn = document.getElementById('submitBtn'); const clearBtn = document.getElementById('clearForm');
    document.getElementById('plate').addEventListener('input', e=>{
      let v=e.target.value.replace(/[^A-Za-z0-9]/g,'').toUpperCase(); v=v.slice(0,6); v=v.replace(/(.{2})(?=.)/g,'$1-'); e.target.value=v.slice(0,8);
    });
    clearBtn.addEventListener('click', ()=>{ form.reset(); updateLocalityVisual(); });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = buildPayloadFromForm();
      try {
        await apiCriar(payload);
        await loadWeek(); // recarrega a semana ap√≥s criar
        form.reset();
        updateLocalityVisual();
        alert('Agendamento criado.');
      } catch(err){
        alert(err.message || 'Falha ao criar agendamento');
      }
    });

    function buildPayloadFromForm(){
      const date = document.getElementById('date').value || null;
      const periodUI = document.getElementById('period').value; // 'Manh√£' | 'Tarde' | ''
      const period = periodUI ? (periodUI==='Manh√£' ? 'MANHA' : 'TARDE') : null;
      const plate = document.getElementById('plate').value.toUpperCase();
      const car_model = document.getElementById('car').value;
      const service_type = document.getElementById('service').value;
      const locality = document.getElementById('locality').value;
      const status = document.getElementById('status').value; // 'NE' | 'VE'
      const notes = document.getElementById('notes').value.trim();
      const extra = (document.getElementById('extra')?.value || '').trim();

      if (!plate || !car_model || !service_type || !locality) throw new Error('Preenche os campos obrigat√≥rios.');
      if (date && !period) throw new Error('Seleciona o per√≠odo (manh√£/tarde) para servi√ßos com data.');

      // Guardamos localidade + notes no campo notes (a BD n√£o tem coluna pr√≥pria p/ localidade)
      const notesMerged = [locality, notes, extra].filter(Boolean).join(' | ');

      return { date, period, plate, car_model, service_type, status, notes: notesMerged };
    }

    // ---------- Handlers (status / delete) ----------
    async function onCardStatusChange(e){
      const card = e.target.closest('.appointment');
      const id = card.dataset.id;
      const chosen = e.target.dataset.status; // 'NE' | 'VE'
      card.querySelectorAll('input[type=checkbox]').forEach(inp=>{ inp.checked = (inp.dataset.status===chosen); });
      try {
        await apiAtualizar(id, { status: chosen });
        await loadWeek();
      } catch(err){
        alert(err.message || 'Falha ao atualizar estado');
      }
    }

    async function onDelete(e){
      const id = e.currentTarget.dataset.id;
      if (!confirm('Eliminar este agendamento?')) return;
      try{
        await apiApagar(id);
        await loadWeek();
      }catch(err){
        alert(err.message || 'Falha ao eliminar');
      }
    }

    // ---------- Load & Render ----------
    function normalizeFromAPI(row){
      // Converte do formato da BD -> formato usado no UI
      // period: 'MANHA'|'TARDE'  -> 'Manh√£'|'Tarde'
      const period = row.period === 'MANHA' ? 'Manh√£' : (row.period === 'TARDE' ? 'Tarde' : '');
      // Extrai "localidade" do in√≠cio de notes se existir (ex: "Guimar√£es | ...")
      let locality = '';
      let notes = row.notes || '';
      if (notes.includes(' | ')) {
        const first = notes.split(' | ')[0];
        if (localityColors[first]) {
          locality = first;
          notes = notes.split(' | ').slice(1).join(' | ');
        }
      } else if (localityColors[notes]) {
        locality = notes; notes='';
      }
      return {
        id: row.id,
        date: row.date || null,
        period,
        plate: row.plate || '',
        car: row.car_model || '',
        service: row.service_type || '',
        locality,
        status: row.status || 'NE',
        notes
      };
    }

    async function loadWeek(){
      const week = [...Array(5)].map((_,i)=>addDays(currentMonday,i));
      const ws = localISO(week[0]);
      const we = localISO(week[4]);
      document.getElementById('weekRange').textContent =
        `${week[0].toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit'})} - ${week[4].toLocaleDateString('pt-PT',{day:'2-digit',month:'2-digit',year:'numeric'})}`;
      try{
        const rows = await apiListar(ws,we);
        appointments = rows.map(normalizeFromAPI);
      }catch(err){
        console.error(err);
        appointments = [];
      }
      renderAll();
    }

    function renderAll(){ renderSchedule(); renderUnscheduled(); renderServicesTable(); renderMobileDay(); attachDeleteHandlers(); }
    function attachDeleteHandlers(){
      document.querySelectorAll('button.delete').forEach(b=>b.addEventListener('click', onDelete));
    }

    // ---------- Init ----------
    function updateLocalityVisual(){
      const val = document.getElementById('locality')?.value || '';
      document.getElementById('localityText').textContent = val || 'Selecione a localidade';
      document.getElementById('localityDot').style.backgroundColor = val ? (localityColors[val]||'#d1d5db') : '#d1d5db';
    }
    (function init(){
      buildLocalityMenu();
      updateLocalityVisual();
      document.getElementById('prevDay').addEventListener('click', ()=>{ mobileDay = localISO(addDays(new Date(mobileDay),-1)); renderMobileDay(); });
      document.getElementById('nextDay').addEventListener('click', ()=>{ mobileDay = localISO(addDays(new Date(mobileDay), 1)); renderMobileDay(); });
      document.getElementById('todayDay').addEventListener('click', ()=>{ mobileDay = localISO(new Date()); renderMobileDay(); });
      loadWeek();
    })();
  </script>
</body>
</html>
